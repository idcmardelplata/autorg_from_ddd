---
name: Commit stage
run-name: ${{github.actor}} esta probando el commit
on:
    push:
        paths-ignore:
            - 'docs/**'
            - 'build/**'
            - 'infra/**'
            - '.gitignore'
            - 'README.md'
    workflow_dispatch:
        inputs:
          branch:
            description: "revert on fail"
            required: true
            default: 'revert_branch'
jobs:
  test:
    runs-on: ubuntu-latest
    steps:

      # Check out repo and set up Python   #
      - name: Check out the repository
        uses: actions/checkout@v3
      - name: "Setup Python, Poetry and Dependencies"
        uses: packetcoders/action-setup-cache-python-poetry@main
        with:
          python-version: 3.11.3
          poetry-version: 1.4.2
          ref: ${{ github.event.inputs.branch }}
          fetch-depth: 0
      # Run your actual job
      - name: Run unit tests
        id: unit_test
        continue-on-error: true
        run: |
          poetry run python ci/commit_stage.py
        
      - name: Undo Push
        uses: exions/undo-push@v1
        if: steps.unit_test.outputs.exit_status != 0
        with:
          branch: ${{ github.event.inputs.branch }}
        
      - name: Build the application
        if: startsWith(github.ref, 'refs/tags')  
        run: |
          poetry run python ci/build_stage.py
